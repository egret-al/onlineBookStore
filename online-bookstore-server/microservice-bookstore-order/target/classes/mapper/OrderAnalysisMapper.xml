<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.onlinebookstore.mapper.OrderAnalysisMapper">
    <resultMap id="orderCoordinateAxisItem" type="com.onlinebookstore.entity.orderserver.OrderCoordinateAxisItem">
        <result property="xAxisData" column="x"/>
        <result property="yAxisData" column="y"/>
    </resultMap>

    <resultMap id="BaseOrderMap" type="com.onlinebookstore.entity.orderserver.Order">
        <id column="serial_number" property="serialNumber" jdbcType="VARCHAR"/>
        <result column="book_id" property="bookId" jdbcType="INTEGER"/>
        <result column="username_id" property="usernameId" jdbcType="VARCHAR"/>
        <result column="order_content" property="orderContent" jdbcType="VARCHAR"/>
        <result column="product_count" property="productCount" jdbcType="INTEGER"/>
        <result column="whole_price" property="wholePrice" jdbcType="INTEGER"/>
        <result column="obtain_score" property="obtainScore" jdbcType="INTEGER"/>
        <result column="create_time" property="createTime" jdbcType="TIMESTAMP"/>
        <result column="payment_time" property="paymentTime" jdbcType="TIMESTAMP"/>
        <result column="delivery_time" property="deliveryTime" jdbcType="TIMESTAMP"/>
        <result column="end_time" property="endTime" jdbcType="TIMESTAMP"/>
        <result column="order_payment_status" property="orderPaymentStatus" jdbcType="INTEGER"/>
        <result column="use_score" property="useScore" jdbcType="INTEGER"/>
        <result column="book_name" property="bookName" jdbcType="VARCHAR"/>
    </resultMap>

    <sql id="orderFields">
        serial_number, book_id, username_id, order_content, product_count, whole_price, obtain_score, create_time,
        payment_time, delivery_time, end_time, order_payment_status, use_score, book_name
    </sql>

    <select id="getOrdersByMonthly" resultMap="BaseOrderMap">
        select <include refid="orderFields"/>
        from sys_order
        where order_payment_status = 1 and date_format(create_time, '%Y-%m') = #{yearAndMonth};
    </select>

    <select id="getOrderSuccessDate" resultType="java.lang.String">
        select distinct date_format(create_time, '%Y-%m') months
        from sys_order
        where order_payment_status = 1
        order by create_time desc;
    </select>

    <select id="getBookNameAndCountWithDealtOrder" resultMap="orderCoordinateAxisItem">
        select book_name x, sum(product_count) y
        from sys_order
        where order_payment_status = 1
        <if test="day != -1">
            and order_payment_status = 1 and date_sub(curdate(), interval #{day} day ) &lt; date(create_time)
        </if>
        group by book_id
        order by sum(product_count) desc
        <if test="count != -1">
            limit #{count};
        </if>
    </select>

    <select id="getBookNameAndWholePriceWithDealtOrder" resultMap="orderCoordinateAxisItem">
        select book_name x, sum(whole_price) y
        from sys_order
        where order_payment_status = 1
        <if test="day != -1">
            and order_payment_status = 1 and date_sub(curdate(), interval #{day} day ) &lt; date(create_time)
        </if>
        group by book_id
        order by sum(whole_price) desc
        <if test="count != -1">
            limit #{count};
        </if>
    </select>
</mapper>